<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" rel="stylesheet">
    <title>Generic title</title>
</head>
<body>
<script type="text/javascript">

    document.addEventListener("DOMContentLoaded", function () {
        let targetElement = document.querySelector('#embed-iframe');
        let callbackElement = document.querySelector('#embed-callback-btn')
        let embedOptions = {
            width: '100%',
            height: 600
        };
        embedSpotifyPlaylist(targetElement, callbackElement, embedOptions, getPlaylistUri, createPlaylistResource)
    });

    function embedSpotifyPlaylist(targetElement, callbackElement, embedOptions, getUri, createResource) {
        let uri = getUri();
        if (uri === null) {
            window.onSpotifyIframeApiReady = (IFrameAPI) => {
                let callback = (EmbedController) => {
                    callbackElement.addEventListener('click', function () {
                            let resource = createResource()
                            let uri = buildSpotifyPlaylistUri(resource)
                            EmbedController.loadUri(uri)
                        }
                    )
                };
                IFrameAPI.createController(targetElement, embedOptions, callback);
            }
            return;
        }
        window.onSpotifyIframeApiReady = (IFrameAPI) => {
            embedOptions.uri = uri
            let callback = (EmbedController) => {
            };
            IFrameAPI.createController(targetElement, embedOptions, callback);
        }
    }

    function buildSpotifyPlaylistUri(resource) {
        let id = resource.id
        return 'spotify:playlist:' + id
    }

    function getPlaylistUri() {
        let playlist = getPlaylist();
        if (playlist === null) return playlist;
        return buildSpotifyPlaylistUri(playlist)
    }

    function createPlaylistResource() {
        let user;
        let playlist;
        user = getUser();
        if (user == null) {
            registerUser();
        }
        playlist = createPlaylist();
        return playlist
    }

    function getUser() {
        const request = sendRequest('GET', 'http://localhost:8082/api/v1/users', null);
        if (request.status === 200) {
            return JSON.parse(request.responseText);
        }
        return null;
    }

    function getPlaylist() {
        const request = sendRequest('GET', 'http://localhost:8082/api/v1/playlists', null);
        if (request.status === 200) {
            return JSON.parse(request.responseText);
        }
        return null;
    }

    function registerUser() {
        const request = sendRequest('POST', 'http://localhost:8082/api/v1/users', null);
        if (request.status === 200) {
            return JSON.parse(request.responseText);
        }
        return null;
    }

    function createPlaylist() {
        const request = sendRequest('POST', 'http://localhost:8082/api/v1/playlists', null);
        if (request.status === 200) {
            return JSON.parse(request.responseText);
        }
        return null;
    }

    function sendRequest(type, url, body) {
        const request = new XMLHttpRequest();
        request.open(type, url, false);
        request.send(body);
        return request;
    }

</script>
<div class="container-sm border">
    <div id="embed-iframe">Player must be here</div>
</div>
<div class="container-sm border">
    <button class="btn btn-primary" id="embed-callback-btn" type="button">Embed playlist</button>
</div>
<script crossorigin="anonymous"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
<script src="https://open.spotify.com/embed-podcast/iframe-api/v1" async>
</script>
</body>
</html>