<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        div.hidden {
            display: none;
        }
    </style>
    <meta charset="UTF-8">
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" rel="stylesheet">
    <title>Generic title</title>
</head>
<body>
<script type="text/javascript">

    document.addEventListener("DOMContentLoaded", () => {
        let controls = document.getElementById("playlist-controls")
        let view = document.getElementById("playlist-view")
        let target = document.getElementById("playlist")
        let create = document.getElementById("create-playlist")
        let update = document.getElementById("update-playlist")
        let options = {
            width: '100%',
            height: 600
        };
        embedPlaylist(target, options, create, update)
        view.classList.remove("hidden")
        controls.classList.remove("hidden")
    });

    function embedPlaylist(embedmentTargetElement, embedmentOptions, createPlaylistElement, updatePlaylistElement) {
        let playlist = getPlaylist()
        if (playlist === null) {
            let updatePlaylistElementClass = updatePlaylistElement.getAttribute("class")
            updatePlaylistElement.setAttribute("class", "invisible")
            window.onSpotifyIframeApiReady = (IFrameAPI) => {
                let callback = (EmbedController) => {
                    createPlaylistElement.addEventListener('click', () => {
                            let user = getUser()
                            if (user === null) {
                                registerUser()
                            }
                            playlist = createPlaylist()
                            let playlistId = playlist.id
                            let playlistUri = 'spotify:playlist:' + playlistId
                            EmbedController.loadUri(playlistUri)
                            createPlaylistElement.setAttribute("class", "invisible")
                            updatePlaylistElement.setAttribute("class", updatePlaylistElementClass)
                        }
                    )
                    updatePlaylistElement.addEventListener('click', () => {
                        let playlist = updatePlaylist()
                        let playlistId = playlist.id
                        let playlistUri = 'spotify:playlist:' + playlistId
                        EmbedController.loadUri(playlistUri)
                    })

                };
                IFrameAPI.createController(embedmentTargetElement, embedmentOptions, callback);
            }
            return;
        }
        createPlaylistElement.setAttribute("class", "invisible")
        window.onSpotifyIframeApiReady = (IFrameAPI) => {
            let playlistId = playlist.id
            embedmentOptions.uri = 'spotify:playlist:' + playlistId
            let callback = (EmbedController) => {
                updatePlaylistElement.addEventListener('click', () => {
                    let playlist = updatePlaylist()
                    let playlistId = playlist.id
                    let playlistUri = 'spotify:playlist:' + playlistId
                    EmbedController.loadUri(playlistUri)
                })
            };
            IFrameAPI.createController(embedmentTargetElement, embedmentOptions, callback);
        }
    }
</script>

<div class="container hidden" id="playlist-view">
    <div id="playlist"></div>
</div>

<div class="container hidden" id="playlist-controls">
    <button class="btn btn-primary" id="create-playlist">Create</button>
    <button class="btn btn-primary" id="update-playlist">Update</button>
</div>

<script type="text/javascript" src="suddenrun-rest-api-client.js"></script>
<script src="https://open.spotify.com/embed-podcast/iframe-api/v1" async></script>
<script crossorigin="anonymous"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
</body>
</html>